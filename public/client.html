<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>
        </title>
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.0.1/jquery.mobile-1.0.1.min.css" />
        <style>
            /* App custom styles */
		  td {
		    padding: 0px 10px 5px 0px;
		    vertical-align: top;	
		  }
        </style>
		<script src="http://www.google.com/jsapi" type="text/javascript"></script>        
        <script type="text/javascript">
			google.load("maps", "3", {'other_params':'sensor=true'});
			google.load("jquery", "1.7");
		</script>
		
        <script src="http://code.jquery.com/mobile/1.0.1/jquery.mobile-1.0.1.min.js">
        </script>
		<script src="js/jquery.ui.map.full.min.js" type="text/javascript">
		</script>
    </head>
    <body>
        <div data-role="page" id="page1">
            <div data-theme="a" data-role="header">
                <h3>
                    Destination
                </h3>
                <a data-role="button" data-transition="flip" href="#page2" class="ui-btn-right">
                    Settings
                </a>
            </div>
            <div data-role="content">
				<div id="map_canvas" style="width:500px;height:500px"></div>
            </div>
        </div>

        <div data-role="page" id="page2">
            <div data-theme="a" data-role="header">
                <h3>
                    Settings
                </h3>
                <a data-role="button" data-rel="back" data-direction="reverse" data-transition="slide" href="#page1">
                    Back
                </a>
            </div>
            <div data-role="content">
                <div data-role="fieldcontain">
                    <fieldset data-role="controlgroup" data-type="vertical">
                        <legend>
                            Size of your group:
                        </legend>
                        <input name="radiobuttons1" id="radio1" value="radio1" type="radio" selected="selected" checked="checked"/>
                        <label for="radio1">
                            1 person
                        </label>
                        <input name="radiobuttons1" id="radio2" value="radio2" type="radio" />
                        <label for="radio2">
                            2 persons
                        </label>
                        <input name="radiobuttons1" id="radio3" value="radio3" type="radio" />
                        <label for="radio3">
                            3 persons
                        </label>
                        <input name="radiobuttons1" id="radio4" value="radio4" type="radio" />
                        <label for="radio4">
                            4 persons
                        </label>
                    </fieldset>
                </div>
               <div class="ui-grid-a">
                    <div class="ui-block-a">
                        <p>
                            Looking for<br /> Kimppis buddies?
                        </p>
                    </div>
                    <div class="ui-block-b">
                        <div data-role="fieldcontain">
                            <fieldset data-role="controlgroup">
                                <label for="toggleswitch1">
                                </label>
                                <select name="toggleswitch1" id="toggleswitch1" data-theme="" data-role="slider">
                                    <option value="off">
                                        No
                                    </option>
                                    <option value="on" selected="selected">
                                        Yes
                                    </option>
                                </select>
                            </fieldset>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div data-role="page" id="page3">
            <div data-theme="a" data-role="header">
                <h3>
                    My Kimppis
                </h3>
                <a data-role="button" data-direction="reverse" data-transition="slide" href="#page1">
                    Back
                </a>
                <a data-role="button" data-transition="flip" href="#page2" class="ui-btn-right">
                    Map
                </a>
            </div>
            <div data-role="content">
                <table>
	               <tr><td><strong>From</strong></td><td id="from_address">Searching...</td></tr>
	               <tr><td><strong>To</strong></td><td id="to_address">Searching...</td></tr>
                    <tr><td></td><td></td></tr>
	               <tr><td colspan="2"><h3>Found 2 Kimppis buddies to share a taxi with you!</h3></td></tr>
                    <tr><td></td><td></td></tr>
	               <tr><td><strong>Price</strong></td><td>
		              <table>
			             <tr><td>Normal:</td><td>23,30 €</td></tr>
			             <tr><td><strong>Kimppis:</strong></td><td><strong>9,20 €</strong></td>
				        <tr><td>You save:</td><td>14,10 €!</td>
		              </table>
		          </td></tr>
	           </table>
                <a data-role="button" data-transition="slide" href="#page4">
                    Accept
                </a>
            </div>
        </div>

        <div data-role="page" id="page4">
            <div data-theme="a" data-role="header">
                <h3>
                    Find buddies
                </h3>
                <a data-role="button" data-direction="reverse" data-transition="slide" href="#page3">
                    Back
                </a>
            </div>
            <div data-role="content">
                <img src="img/kimppis02.png" alt="" />
                <h3>Please lift your phone to find your buddies!</h3>
                <a data-role="button" data-transition="slide" href="#page5">
                    Ready!
                </a>
            </div>
        </div>

        <div data-role="page" id="page5">
            <div data-theme="a" data-role="header">
                <h3>
                    Find buddies
                </h3>
                <a data-role="button" data-direction="reverse" data-transition="slide" href="#page4">
                    Back
                </a>
            </div>
            <div data-role="content">
	           <a data-transition="slide" href="#page6"><img src="img/kimppis-flash.gif" alt="" /></a>
            </div>
        </div>

        <div data-role="page" id="page6">
            <div data-theme="a" data-role="header">
                <h3>
                    Fare breakdown
                </h3>
                <a data-role="button" data-direction="reverse" data-transition="slide" href="#page5">
                    Back
                </a>
                <a data-role="button" data-transition="flip" href="#page7" class="ui-btn-right">
                    Route
                </a>
            </div>
            <div data-role="content">
                <h3>Destinations</h3>
                <table style="width: 100%;">
	               <tr><td><strong>You</strong> (10,3 km)</td><td style="float:right;"><strong>9,20 €</strong></td></tr>
	               <tr><td colspan="2">Betonimiehenkuja 3, Espoo</td></tr>
	               <tr><td colspan="2"><hr /></td></tr>
	               <tr><td><strong>Buddy 1</strong> (12,2 km)</td><td style="float:right;"><strong>11,00 €</strong></td></tr>
	               <tr><td colspan="2">Tapionaukio 3, Espoo</td></tr>
	               <tr><td colspan="2"><hr /></td></tr>
	               <tr><td><strong>Buddy 2</strong> (16,3 km)</td><td style="float:right;"><strong>14,70 €</strong></td></tr>
	               <tr><td colspan="2">Sakkolantie 1, Espoo</td></tr>
	               <tr><td colspan="2"><hr /></td></tr>
	               <tr><td><strong>TOTAL</strong> (16,3 km)</td><td style="float:right;"><strong>34,90 €</strong></td></tr>
	               <tr><td></td><td></td></tr>
	           </table>
            </div>
        </div>


        <div data-role="page" id="page7">
            <div data-theme="a" data-role="header">
                <h3>
                    Route
                </h3>
                <a data-role="button" data-rel="back" data-direction="reverse" data-transition="slide" href="#page6">
                    Back
                </a>
            </div>
            <div data-role="content">
                <h1>Route map</h1>
            </div>
        </div>
        <script>
		// Constants
		var SERVER = 'http://localhost:8080'
		// Variables
		var persons = 1;
		var finder = true;
		
		var position_latLng = null;
		var destination_latLng = null;
		
		// Page 1 (Map)
		$('#page1').live("pageshow", function() {
			$('#map_canvas').gmap( { 'center': getLatLng(), zoom: 12, 'callback': 
				function (map) {
					// Add location
					if ( navigator.geolocation ) {
						watch = navigator.geolocation.watchPosition ( 
							function( position ) { 
								// Get position
								position_latLng = new google.maps.LatLng(position.coords.latitude, 
																			 position.coords.longitude);
								
								// Set position
								$('#map_canvas').gmap('clear', 'markers');
								$('#map_canvas').gmap('addMarker', 
									{ 'title'	: 'You are here!', 
									  'bound'	: false, 
									  'position': position_latLng,
									  'icon'	: new google.maps.MarkerImage('img/blue-dot.png', null, null, new google.maps.Point(25, 25))
								  	}
								);
								map.panTo( position_latLng );
							}
						);
					}
					
					// Add event listener
					google.maps.event.addListener(map, 'click', function (event) {
						// Store positions, go to next page
						destination_latLng = event.latLng;
						$.mobile.changePage($('#page3'));
					});
				}
			});
			
			function getLatLng() {
				if ( google.loader.ClientLocation != null ) {
					return new google.maps.LatLng(google.loader.ClientLocation.latitude, google.loader.ClientLocation.longitude);	
				}
				return new google.maps.LatLng(65.171916, 20.941196);
			}

		});
				
		$('#page1').live("pagehide", function() {
			if ( navigator.geolocation ) {
				navigator.geolocation.clearWatch(watch);
            }
		});
				
		$('#page1').live("pagecreate", function() {
			var watch;
		});
		
		// Page 2 (Settings)
		$('#radio1').change(function(event) {persons = 1});
		$('#radio2').change(function(event) {persons = 2});
		$('#radio3').change(function(event) {persons = 3});
		$('#radio4').change(function(event) {persons = 4});
		
		$('#toggleswitch1').change(function(event) {finder = !finder});
		
		// Page 3 (Route data)
		$('#page3').live("pageshow", function() {
			// Devel defaults
			position_latLng = position_latLng || new google.maps.LatLng(60, 24)
			destination_latLng = destination_latLng || new google.maps.LatLng(60, 24)
			
			// Update form / to
			latLng_to_string(position_latLng, function(address) {
				$('#from_address').html(address);
			});
			latLng_to_string(destination_latLng, function(address) {
				$('#to_address').html(address);
			});
			
			// Get route data
			$.post({
				url: SERVER + '/request',
				data: {position: [position_latLng.longitude, position_latLng.latitude],
				   	destination: [destination_latLng.longitude, destination_latLng.latitude],
			   	  	places: persons}, 
				success: function() {
					console.log("done!");
				},
				fail: function(jqXHR, textStatus) {
					console.log(textStatus);
				}
			});
		});
		
		latLng_to_string = function(latlng, callback) {
			if (!latlng) {
				callback("Unkown");
				return;
			}
			
			var geocoder = new google.maps.Geocoder();
			geocoder.geocode({'latLng': latlng}, function(results, status) {
				if (status == google.maps.GeocoderStatus.OK) {
					if (results[0]) {
						var string = results[0].formatted_address;
						callback(string);
					}
				} else {
					console.log("Geocoder failed due to: " + status);
				}
			});
		}
		
		
		handle_route = function(route) {
			console.log(route);
		}
		
		
        </script>
    </body>
</html>